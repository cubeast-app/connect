name: 'Upload Version-Agnostic Assets'

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v0.7.1)'
        required: true
        type: string
  workflow_call:
    inputs:
      tag:
        description: 'Release tag (e.g., v0.7.1)'
        required: true
        type: string

jobs:
  upload:
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    steps:
      - name: Download release assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ inputs.tag }}"
          VERSION="${TAG#v}"
          echo "Processing tag: $TAG (version: $VERSION)"

          # Create temp directory
          mkdir -p temp_assets
          cd temp_assets

          # Download all assets from the release
          gh release download "$TAG" --repo ${{ github.repository }}

          echo "Downloaded files:"
          ls -lh

          # Windows: .msi installer
          if [ -f "Cubeast.Connect_${VERSION}_x64_en-US.msi" ]; then
            echo "Creating version-agnostic Windows MSI installer..."
            cp "Cubeast.Connect_${VERSION}_x64_en-US.msi" "Cubeast.Connect_x64_en-US.msi"
            gh release upload "$TAG" "Cubeast.Connect_x64_en-US.msi" --repo ${{ github.repository }} --clobber
            echo "✓ Uploaded Cubeast.Connect_x64_en-US.msi"
          else
            echo "⚠ Windows MSI installer not found: Cubeast.Connect_${VERSION}_x64_en-US.msi"
          fi

          # macOS: .dmg (Apple Silicon)
          if [ -f "Cubeast.Connect_${VERSION}_aarch64.dmg" ]; then
            echo "Creating version-agnostic macOS installer..."
            cp "Cubeast.Connect_${VERSION}_aarch64.dmg" "Cubeast.Connect_aarch64.dmg"
            gh release upload "$TAG" "Cubeast.Connect_aarch64.dmg" --repo ${{ github.repository }} --clobber
            echo "✓ Uploaded Cubeast.Connect_aarch64.dmg"
          else
            echo "⚠ macOS installer not found: Cubeast.Connect_${VERSION}_aarch64.dmg"
          fi

          # Linux: .AppImage
          if [ -f "Cubeast.Connect_${VERSION}_amd64.AppImage" ]; then
            echo "Creating version-agnostic Linux installer..."
            cp "Cubeast.Connect_${VERSION}_amd64.AppImage" "Cubeast.Connect_amd64.AppImage"
            gh release upload "$TAG" "Cubeast.Connect_amd64.AppImage" --repo ${{ github.repository }} --clobber
            echo "✓ Uploaded Cubeast.Connect_amd64.AppImage"
          else
            echo "⚠ Linux installer not found: Cubeast.Connect_${VERSION}_amd64.AppImage"
          fi
